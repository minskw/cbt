<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Ujian Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        /* Arabic text styling */
        .arabic-text {
            font-family: 'Amiri', serif;
            font-size: 1.1em;
            line-height: 1.8;
        }
        
        .question-text {
            font-family: 'Amiri', serif;
        }
        
        .option-text {
            font-family: 'Amiri', serif;
        }
        
        /* Auto text direction detection */
        .auto-direction {
            unicode-bidi: plaintext;
        }
        
        /* Image styling for questions and options */
        .question-image {
            max-height: 100px;
            width: auto;
            object-fit: contain;
            border-radius: 8px;
            margin: 8px 0;
        }
        
        .option-image {
            max-height: 80px;
            width: auto;
            object-fit: contain;
            border-radius: 6px;
            margin: 4px 0;
        }
        
        /* RTL support for pure Arabic text */
        .rtl-text {
            direction: rtl;
            text-align: right;
        }
        
        .ltr-text {
            direction: ltr;
            text-align: left;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Smart Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 slide-up">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4">
                    <img src="https://archive.org/download/logo-min-singkawang/logo%20min.png" alt="Logo MIN Singkawang" class="w-full h-full object-contain" onerror="this.src=''; this.alt='Logo failed to load'; this.style.display='none';">
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Sistem Ujian Online</h1>
                <p class="text-gray-600">MIN SINGKAWANG</p>
            </div>
            
            <form id="smartLoginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username / NIS</label>
                    <input type="text" id="loginUsername" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan username atau NIS" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan password" required>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105">
                    üöÄ Masuk
                </button>
            </form>
            

        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacherDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b-4 border-blue-500">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10">
                            <img src="https://archive.org/download/logo-min-singkawang/logo%20min.png" alt="Logo MIN Singkawang" class="w-full h-full object-contain" onerror="this.src=''; this.alt='Logo failed to load'; this.style.display='none';">
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Dashboard Guru</h1>
                            <p class="text-sm text-gray-600" id="teacherWelcome">Selamat datang, Guru</p>
                            <p class="text-xs" id="connectionStatus">üü° Checking connection...</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="syncData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2" id="syncButton">
                            <span>üîÑ</span>
                            <span>Sync</span>
                        </button>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <span>üö™</span>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white shadow-md border-b">
            <div class="container mx-auto px-4">
                <div class="flex space-x-8 overflow-x-auto">
                    <button class="teacher-nav-btn py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium whitespace-nowrap" data-tab="teacher-dashboard">Dashboard</button>
                    <button class="teacher-nav-btn py-4 px-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 font-medium whitespace-nowrap" data-tab="teacher-students">Kelola Siswa</button>
                    <button class="teacher-nav-btn py-4 px-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 font-medium whitespace-nowrap" data-tab="teacher-questions">Kelola Soal</button>
                    <button class="teacher-nav-btn py-4 px-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 font-medium whitespace-nowrap" data-tab="teacher-exam">Kelola Ujian</button>
                    <button class="teacher-nav-btn py-4 px-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 font-medium whitespace-nowrap" data-tab="teacher-results">Hasil Ujian</button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6">
            <!-- Teacher Dashboard Tab -->
            <div id="teacher-dashboard" class="teacher-tab-content fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Total Siswa</p>
                                <p class="text-3xl font-bold text-gray-800" id="teacherTotalStudents">0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <span class="text-2xl">üë•</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Total Soal</p>
                                <p class="text-3xl font-bold text-gray-800" id="teacherTotalQuestions">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <span class="text-2xl">‚ùì</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Ujian Aktif</p>
                                <p class="text-3xl font-bold text-gray-800" id="teacherActiveExams">0</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <span class="text-2xl">üìù</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Rata-rata Nilai</p>
                                <p class="text-3xl font-bold text-gray-800" id="teacherAverageScore">0</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <span class="text-2xl">üìà</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Selamat Datang di Dashboard Guru</h2>
                    <p class="text-gray-600 mb-4">Kelola ujian online dengan mudah dan efisien. Fitur yang tersedia:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center space-x-3 p-3 bg-blue-50 rounded-lg">
                            <span class="text-blue-500 text-xl">üìä</span>
                            <span class="text-gray-700">Import data siswa dari Excel</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                            <span class="text-green-500 text-xl">üìù</span>
                            <span class="text-gray-700">Import soal dari Excel</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 bg-yellow-50 rounded-lg">
                            <span class="text-yellow-500 text-xl">‚è±Ô∏è</span>
                            <span class="text-gray-700">Timer ujian otomatis</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 bg-purple-50 rounded-lg">
                            <span class="text-purple-500 text-xl">üì±</span>
                            <span class="text-gray-700">Responsive mobile-friendly</span>
                        </div>
                    </div>
                </div>

                <!-- Google Sheets Setup Instructions -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6">
                    <h3 class="text-lg font-bold text-blue-800 mb-4">üîó Integrasi Google Sheets</h3>
                    <div class="space-y-4">
                        <div class="bg-white rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Status Koneksi:</h4>
                            <p class="text-sm text-gray-700" id="connectionInfo">Sistem terhubung dengan Google Sheets untuk penyimpanan data real-time.</p>
                        </div>
                        <div class="bg-white rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Keuntungan Google Sheets:</h4>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                                <li>Data tersimpan di cloud secara otomatis</li>
                                <li>Dapat diakses dari berbagai perangkat</li>
                                <li>Backup data yang aman</li>
                                <li>Kolaborasi real-time antar guru</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teacher Students Tab -->
            <div id="teacher-students" class="teacher-tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">Kelola Data Siswa</h2>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <label class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors flex items-center space-x-2">
                                <span>üìÅ</span>
                                <span>Import Excel</span>
                                <input type="file" id="teacherStudentFileInput" accept=".xlsx,.xls" class="hidden">
                            </label>
                            <button id="teacherAddStudentBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                                <span>‚ûï</span>
                                <span>Tambah Siswa</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <input type="text" id="teacherStudentSearch" placeholder="Cari siswa..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">NIS</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Nama</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Kelas</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Email</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Password</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="teacherStudentsTable">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500">Belum ada data siswa. Import dari Excel atau tambah manual.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Format Excel Info -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">Format Excel untuk Import Siswa:</h3>
                    <p class="text-blue-700 text-sm mb-2">Kolom yang diperlukan: NIS | Nama | Kelas | Email | Password</p>
                    <div class="text-xs text-blue-600">
                        <p>Contoh: 12345 | Ahmad Budi | XII IPA 1 | ahmad@email.com | 123</p>
                    </div>
                </div>
            </div>

            <!-- Teacher Questions Tab -->
            <div id="teacher-questions" class="teacher-tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">Kelola Bank Soal</h2>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <label class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors flex items-center space-x-2">
                                <span>üìÅ</span>
                                <span>Import Excel</span>
                                <input type="file" id="teacherQuestionFileInput" accept=".xlsx,.xls" class="hidden">
                            </label>
                            <button id="teacherAddQuestionBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                                <span>‚ûï</span>
                                <span>Tambah Soal</span>
                            </button>
                        </div>
                    </div>

                    <div class="mb-4 flex flex-col md:flex-row gap-4">
                        <input type="text" id="teacherQuestionSearch" placeholder="Cari soal..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <select id="teacherQuestionSubjectFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Semua Mata Pelajaran</option>
                        </select>
                    </div>

                    <div id="teacherQuestionsList" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            Belum ada soal. Import dari Excel atau tambah manual.
                        </div>
                    </div>
                </div>

                <!-- Format Excel Info -->
                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                    <h3 class="font-semibold text-green-800 mb-2">Format Excel untuk Import Soal:</h3>
                    <p class="text-green-700 text-sm mb-2">Kolom: Soal | Pilihan A | Pilihan B | Pilihan C | Pilihan D | Jawaban Benar | Mata Pelajaran | Kategori</p>
                    <div class="text-xs text-green-600 space-y-1">
                        <p>‚Ä¢ Jawaban Benar: A, B, C, atau D | Mata Pelajaran: Matematika, Fisika, dll.</p>
                        <p>‚Ä¢ Untuk gambar dalam soal/opsi: [IMG:https://example.com/image.jpg]</p>
                        <p>‚Ä¢ Teks Arab akan otomatis menggunakan font Amiri dan arah RTL jika murni Arab</p>
                        <p>‚Ä¢ Teks campuran Latin+Arab tetap LTR dengan font Amiri</p>
                    </div>
                </div>
            </div>

            <!-- Teacher Exam Tab -->
            <div id="teacher-exam" class="teacher-tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Kelola Ujian</h2>
                    
                    <!-- Active Exams -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Ujian Aktif</h3>
                        <div id="activeExamsList" class="space-y-4">
                            <div class="text-center py-8 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">
                                Tidak ada ujian yang sedang berlangsung
                            </div>
                        </div>
                    </div>

                    <!-- Create New Exam -->
                    <div class="border-t pt-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Buat Ujian Baru</h3>
                        <form id="teacherExamForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Ujian</label>
                                    <input type="text" id="teacherExamTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Ujian Matematika Semester 1" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                    <select id="teacherExamSubject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                        <option value="">Pilih mata pelajaran</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Durasi (menit)</label>
                                    <input type="number" id="teacherExamDuration" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="90" min="1" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Soal</label>
                                    <input type="number" id="teacherExamQuestionCount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="20" min="1" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                                    <select id="teacherExamClass" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                        <option value="">Pilih kelas untuk ujian</option>
                                    </select>
                                </div>
                                <div class="flex items-center">
                                    <span class="text-sm text-gray-600" id="availableQuestionsCount">Soal tersedia: 0</span>
                                </div>
                            </div>
                            <button type="submit" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors font-medium">
                                üöÄ Buat Ujian
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Teacher Results Tab -->
            <div id="teacher-results" class="teacher-tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Hasil Ujian</h2>
                    <div id="teacherResultsList" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            Belum ada hasil ujian.
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Student Dashboard -->
    <div id="studentDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b-4 border-green-500">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10">
                            <img src="https://archive.org/download/logo-min-singkawang/logo%20min.png" alt="Logo MIN Singkawang" class="w-full h-full object-contain" onerror="this.src=''; this.alt='Logo failed to load'; this.style.display='none';">
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Dashboard Siswa</h1>
                            <p class="text-sm text-gray-600" id="studentWelcome">Selamat datang, Siswa</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="syncData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2" id="syncButton">
                            <span>üîÑ</span>
                            <span>Sync</span>
                        </button>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <span>üö™</span>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6">
            <!-- Available Exams -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Ujian Tersedia</h2>
                <div id="availableExamsList" class="space-y-4">
                    <div class="text-center py-8 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">
                        Tidak ada ujian yang tersedia saat ini
                    </div>
                </div>
            </div>

            <!-- Student Exam Interface -->
            <div id="studentExamInterface" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800" id="studentCurrentExamTitle">Ujian Berlangsung</h2>
                            <p class="text-gray-600" id="studentCurrentInfo">Siswa: -</p>
                        </div>
                        <div class="mt-4 md:mt-0">
                            <div class="bg-red-100 border border-red-300 rounded-lg px-4 py-2">
                                <span class="text-red-700 font-bold text-lg" id="studentExamTimer">00:00</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-600">Progress</span>
                            <span class="text-sm text-gray-600" id="studentQuestionProgress">0/0</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full transition-all duration-300" id="studentProgressBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="studentQuestionContainer" class="mb-6">
                        <!-- Questions will be loaded here -->
                    </div>

                    <div class="flex justify-between items-center">
                        <button id="studentPrevQuestion" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors disabled:opacity-50">
                            ‚Üê Sebelumnya
                        </button>
                        <button id="studentNextQuestion" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors">
                            Selanjutnya ‚Üí
                        </button>
                        <button id="studentFinishExam" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors hidden">
                            ‚úÖ Selesai Ujian
                        </button>
                    </div>
                </div>
            </div>

            <!-- Student Results -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Riwayat Ujian Saya</h2>
                <div id="studentResultsList" class="space-y-4">
                    <div class="text-center py-8 text-gray-500">
                        Belum ada riwayat ujian.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Add Student Modal -->
    <div id="teacherAddStudentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full slide-up">
            <div class="p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Tambah Siswa Baru</h3>
                <form id="teacherAddStudentForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIS</label>
                        <input type="text" id="teacherNewStudentNIS" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama</label>
                        <input type="text" id="teacherNewStudentName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                        <input type="text" id="teacherNewStudentClass" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="teacherNewStudentEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="teacherNewStudentPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Password untuk login siswa" required>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" id="teacherCancelAddStudent" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-colors">Batal</button>
                        <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition-colors">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div id="teacherAddQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full slide-up max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Tambah Soal Baru</h3>
                <form id="teacherAddQuestionForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Soal</label>
                        <textarea id="teacherNewQuestionText" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 h-24 question-text auto-direction" placeholder="Masukkan soal. Untuk gambar gunakan format: [IMG:https://example.com/image.jpg]" required></textarea>
                        <p class="text-xs text-gray-500 mt-1">üí° Untuk menyisipkan gambar: [IMG:URL_GAMBAR]</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan A</label>
                            <input type="text" id="teacherNewQuestionA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 option-text auto-direction" placeholder="Teks atau [IMG:URL_GAMBAR]" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan B</label>
                            <input type="text" id="teacherNewQuestionB" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 option-text auto-direction" placeholder="Teks atau [IMG:URL_GAMBAR]" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan C</label>
                            <input type="text" id="teacherNewQuestionC" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 option-text auto-direction" placeholder="Teks atau [IMG:URL_GAMBAR]" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan D</label>
                            <input type="text" id="teacherNewQuestionD" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 option-text auto-direction" placeholder="Teks atau [IMG:URL_GAMBAR]" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jawaban Benar</label>
                            <select id="teacherNewQuestionAnswer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Pilih jawaban</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                            <input type="text" id="teacherNewQuestionSubject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Matematika" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kategori/Topik</label>
                            <input type="text" id="teacherNewQuestionCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Aljabar">
                        </div>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" id="teacherCancelAddQuestion" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-colors">Batal</button>
                        <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition-colors">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let students = [];
        let questions = [];
        let examResults = [];
        let activeExams = [];
        let currentUser = null;
        let currentExam = null;
        let currentQuestionIndex = 0;
        let examTimer = null;

        // Text formatting functions
        function isArabicText(text) {
            // Check if text contains Arabic characters
            const arabicRegex = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
            return arabicRegex.test(text);
        }

        function isPureArabic(text) {
            // Check if text is purely Arabic (no Latin characters)
            const latinRegex = /[A-Za-z]/;
            const arabicRegex = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
            return arabicRegex.test(text) && !latinRegex.test(text.replace(/[0-9\s\p{P}]/gu, ''));
        }

        function formatTextWithImages(text, type = 'question') {
            if (!text) return '';
            
            // Replace image placeholders with actual img tags
            const imageClass = type === 'question' ? 'question-image' : 'option-image';
            let formattedText = text.replace(/\[IMG:(https?:\/\/[^\]]+)\]/g, 
                `<img src="$1" alt="Image" class="${imageClass}" onerror="this.style.display='none'; this.alt='Image failed to load';">`
            );
            
            // Apply text direction based on content
            const textDirection = isPureArabic(formattedText.replace(/<[^>]*>/g, '')) ? 'rtl-text' : 'ltr-text';
            
            return `<div class="${textDirection}">${formattedText}</div>`;
        }

        function applyTextDirection(element) {
            if (!element) return;
            
            const text = element.textContent || element.innerText || '';
            if (isPureArabic(text)) {
                element.classList.add('rtl-text');
                element.classList.remove('ltr-text');
            } else {
                element.classList.add('ltr-text');
                element.classList.remove('rtl-text');
            }
        }

        // Google Apps Script Configuration - GANTI DENGAN URL DEPLOYMENT ANDA
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx0XBzbMLv2rsuy-T8kj7GEof3OBV-nmBtORS3vN69ldHfHYwPXsjf3_5I_pqvt5Pv7PA/exec';
        let isOnlineMode = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            setupEventListeners();
            await loadStoredData();
            await checkOnlineMode();
            setupTextDirectionHandlers();
            updateAllDashboards();
        }

        function setupTextDirectionHandlers() {
            // Add event listeners for automatic text direction detection
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('auto-direction') || 
                    e.target.classList.contains('question-text') || 
                    e.target.classList.contains('option-text')) {
                    applyTextDirection(e.target);
                }
            });

            // Apply direction to existing elements
            document.querySelectorAll('.auto-direction, .question-text, .option-text').forEach(applyTextDirection);
        }

        // Google Sheets Integration Functions
        async function checkOnlineMode() {
            // Skip check if URL is not configured
            if (APPS_SCRIPT_URL.includes('YOUR_SCRIPT_ID')) {
                isOnlineMode = false;
                showOnlineStatus(false, 'URL Apps Script belum dikonfigurasi');
                return;
            }

            try {
                console.log('Checking connection to:', APPS_SCRIPT_URL);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(APPS_SCRIPT_URL + '?action=test', {
                    method: 'GET',
                    mode: 'cors',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const result = await response.text();
                    console.log('Connection test response:', result);
                    isOnlineMode = true;
                    showOnlineStatus(true);
                    
                    // Load data from Google Sheets after successful connection
                    await loadDataFromGoogleSheets();
                } else {
                    console.log('Connection failed with status:', response.status);
                    isOnlineMode = false;
                    showOnlineStatus(false, `HTTP ${response.status}`);
                }
            } catch (error) {
                console.log('Connection error:', error.message);
                isOnlineMode = false;
                showOnlineStatus(false, error.name === 'AbortError' ? 'Timeout' : 'Connection failed');
            }
        }

        function showOnlineStatus(online, message = '') {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                if (online) {
                    statusElement.innerHTML = '<span class="text-green-600">üü¢ Online (Google Sheets)</span>';
                } else {
                    const errorMsg = message ? ` - ${message}` : '';
                    statusElement.innerHTML = `<span class="text-red-600">üî¥ Offline (Local Storage)${errorMsg}</span>`;
                }
            }
        }

        async function syncWithGoogleSheets(action, data = null) {
            if (!isOnlineMode) {
                console.log('Offline mode - using local storage');
                return null;
            }

            try {
                const payload = {
                    action: action,
                    data: data
                };

                console.log('Sending to Google Sheets:', payload);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse JSON response:', responseText);
                    throw new Error('Invalid JSON response from server');
                }

                console.log('Google Sheets response:', result);
                return result;
            } catch (error) {
                console.error('Error syncing with Google Sheets:', error);
                if (error.name !== 'AbortError') {
                    isOnlineMode = false;
                    showOnlineStatus(false, 'Sync failed');
                }
                return null;
            }
        }

        async function loadDataFromGoogleSheets() {
            if (!isOnlineMode) {
                console.log('Skipping Google Sheets load - offline mode');
                return;
            }

            try {
                console.log('Loading data from Google Sheets...');
                const result = await syncWithGoogleSheets('loadAll');
                
                if (result && result.success) {
                    // Merge with existing local data
                    const loadedStudents = result.data.students || [];
                    const loadedQuestions = result.data.questions || [];
                    const loadedExamResults = result.data.examResults || [];
                    const loadedActiveExams = result.data.activeExams || [];
                    
                    console.log('Loaded from Google Sheets:', {
                        students: loadedStudents.length,
                        questions: loadedQuestions.length,
                        examResults: loadedExamResults.length,
                        activeExams: loadedActiveExams.length
                    });
                    
                    // Update arrays with loaded data
                    students = loadedStudents;
                    questions = loadedQuestions;
                    examResults = loadedExamResults;
                    activeExams = loadedActiveExams;
                    
                    // Save to local storage as backup
                    localStorage.setItem('examSystem', JSON.stringify({
                        students,
                        questions,
                        examResults,
                        activeExams
                    }));
                    
                    console.log('Data loaded and synced from Google Sheets');
                    updateAllDashboards();
                } else {
                    console.log('No data received from Google Sheets or operation failed');
                    if (result) {
                        console.log('Result:', result);
                    }
                }
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                showOnlineStatus(false, 'Load failed');
            }
        }

        async function saveDataToGoogleSheets() {
            if (!isOnlineMode) return;

            try {
                const data = {
                    students,
                    questions,
                    examResults,
                    activeExams
                };

                const result = await syncWithGoogleSheets('saveAll', data);
                if (result && result.success) {
                    console.log('Data saved to Google Sheets');
                } else {
                    console.error('Failed to save to Google Sheets');
                }
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
            }
        }

        function setupEventListeners() {
            // Smart login form
            document.getElementById('smartLoginForm').addEventListener('submit', handleSmartLogin);

            // Teacher navigation
            document.querySelectorAll('.teacher-nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchTeacherTab(e.target.dataset.tab));
            });

            // Teacher file inputs
            document.getElementById('teacherStudentFileInput').addEventListener('change', handleTeacherStudentFileImport);
            document.getElementById('teacherQuestionFileInput').addEventListener('change', handleTeacherQuestionFileImport);

            // Teacher modal controls
            document.getElementById('teacherAddStudentBtn').addEventListener('click', () => showModal('teacherAddStudentModal'));
            document.getElementById('teacherAddQuestionBtn').addEventListener('click', () => showModal('teacherAddQuestionModal'));
            document.getElementById('teacherCancelAddStudent').addEventListener('click', () => hideModal('teacherAddStudentModal'));
            document.getElementById('teacherCancelAddQuestion').addEventListener('click', () => hideModal('teacherAddQuestionModal'));

            // Teacher forms
            document.getElementById('teacherAddStudentForm').addEventListener('submit', handleTeacherAddStudent);
            document.getElementById('teacherAddQuestionForm').addEventListener('submit', handleTeacherAddQuestion);
            document.getElementById('teacherExamForm').addEventListener('submit', handleTeacherCreateExam);

            // Teacher search and filters
            document.getElementById('teacherStudentSearch').addEventListener('input', filterTeacherStudents);
            document.getElementById('teacherQuestionSearch').addEventListener('input', filterTeacherQuestions);
            document.getElementById('teacherQuestionSubjectFilter').addEventListener('change', filterTeacherQuestions);
            document.getElementById('teacherExamSubject').addEventListener('change', updateAvailableQuestionsCount);

            // Student exam controls
            document.getElementById('studentPrevQuestion').addEventListener('click', () => navigateStudentQuestion(-1));
            document.getElementById('studentNextQuestion').addEventListener('click', () => navigateStudentQuestion(1));
            document.getElementById('studentFinishExam').addEventListener('click', finishStudentExam);
        }

        function handleSmartLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            console.log('Smart login attempt:', { username, password });

            // First, check if it's a teacher login
            if (username === 'guru' && password === '123') {
                currentUser = { role: 'teacher', name: 'Guru', username: username };
                console.log('Teacher login successful');
                showTeacherDashboard();
                return;
            }

            // Check if it's a student login (by NIS)
            const student = students.find(s => {
                const nisMatch = s.nis && s.nis.toString().trim() === username;
                const passwordMatch = s.password && s.password.toString().trim() === password;
                console.log(`Checking student: ${s.name} (${s.nis}) - NIS match: ${nisMatch}, Password match: ${passwordMatch}`);
                return nisMatch && passwordMatch;
            });
            
            if (student) {
                currentUser = { role: 'student', ...student };
                console.log('Student login successful:', currentUser);
                showStudentDashboard();
                return;
            }

            // Login failed
            if (students.length === 0) {
                alert('Belum ada data siswa dalam sistem. Silakan hubungi guru untuk menambahkan data siswa terlebih dahulu.\n\nüë®‚Äçüè´ Login Guru:\nUsername: guru | Password: 123');
            } else {
                alert('Username/NIS atau password salah!\n\nüë®‚Äçüè´ Login Guru:\nUsername: guru | Password: 123\n\nSilakan hubungi guru jika lupa NIS atau password Anda.');
            }
        }

        function showTeacherDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('teacherDashboard').classList.remove('hidden');
            document.getElementById('teacherWelcome').textContent = `Selamat datang, ${currentUser.name}`;
            updateTeacherDashboard();
            updateTeacherExamOptions();
        }

        function showStudentDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('studentDashboard').classList.remove('hidden');
            document.getElementById('studentWelcome').textContent = `Selamat datang, ${currentUser.name}`;
            updateStudentDashboard();
        }

        function logout() {
            currentUser = null;
            currentExam = null;
            if (examTimer) {
                clearInterval(examTimer);
                examTimer = null;
            }
            
            // Hide all dashboards
            document.getElementById('teacherDashboard').classList.add('hidden');
            document.getElementById('studentDashboard').classList.add('hidden');
            
            // Show login screen
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Reset forms
            document.getElementById('smartLoginForm').reset();
        }

        function switchTeacherTab(tabName) {
            // Hide all teacher tabs
            document.querySelectorAll('.teacher-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');

            // Update navigation
            document.querySelectorAll('.teacher-nav-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-blue-500', 'text-blue-600');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-600');

            // Update content based on tab
            if (tabName === 'teacher-exam') {
                updateTeacherExamOptions();
                renderActiveExams();
            } else if (tabName === 'teacher-questions') {
                updateQuestionSubjectFilter();
            }
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('flex');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        // Teacher functions
        function handleTeacherStudentFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    const importedStudents = data.slice(1).map(row => ({
                        id: Date.now() + Math.random(),
                        nis: row[0] || '',
                        name: row[1] || '',
                        class: row[2] || '',
                        email: row[3] || '',
                        password: row[4] || '123'
                    })).filter(student => student.nis && student.name);

                    students = [...students, ...importedStudents];
                    saveData();
                    renderTeacherStudents();
                    updateTeacherDashboard();
                    
                    alert(`Berhasil import ${importedStudents.length} siswa!`);
                } catch (error) {
                    alert('Error membaca file Excel. Pastikan format sesuai.');
                }
            };
            reader.readAsBinaryString(file);
        }

        function handleTeacherQuestionFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    const importedQuestions = data.slice(1).map(row => ({
                        id: Date.now() + Math.random(),
                        question: row[0] || '',
                        options: {
                            A: row[1] || '',
                            B: row[2] || '',
                            C: row[3] || '',
                            D: row[4] || ''
                        },
                        correctAnswer: row[5] || '',
                        subject: row[6] || 'Umum',
                        category: row[7] || 'Umum'
                    })).filter(q => q.question && q.options.A && q.subject);

                    questions = [...questions, ...importedQuestions];
                    saveData();
                    renderTeacherQuestions();
                    updateTeacherDashboard();
                    updateQuestionSubjectFilter();
                    updateTeacherExamOptions();
                    
                    alert(`Berhasil import ${importedQuestions.length} soal!`);
                } catch (error) {
                    alert('Error membaca file Excel. Pastikan format sesuai.');
                }
            };
            reader.readAsBinaryString(file);
        }

        function handleTeacherAddStudent(event) {
            event.preventDefault();
            
            const newStudent = {
                id: Date.now(),
                nis: document.getElementById('teacherNewStudentNIS').value,
                name: document.getElementById('teacherNewStudentName').value,
                class: document.getElementById('teacherNewStudentClass').value,
                email: document.getElementById('teacherNewStudentEmail').value,
                password: document.getElementById('teacherNewStudentPassword').value
            };

            students.push(newStudent);
            saveData();
            renderTeacherStudents();
            updateTeacherDashboard();
            hideModal('teacherAddStudentModal');
            document.getElementById('teacherAddStudentForm').reset();
        }

        function handleTeacherAddQuestion(event) {
            event.preventDefault();
            
            const newQuestion = {
                id: Date.now(),
                question: document.getElementById('teacherNewQuestionText').value,
                options: {
                    A: document.getElementById('teacherNewQuestionA').value,
                    B: document.getElementById('teacherNewQuestionB').value,
                    C: document.getElementById('teacherNewQuestionC').value,
                    D: document.getElementById('teacherNewQuestionD').value
                },
                correctAnswer: document.getElementById('teacherNewQuestionAnswer').value,
                subject: document.getElementById('teacherNewQuestionSubject').value,
                category: document.getElementById('teacherNewQuestionCategory').value || 'Umum'
            };

            questions.push(newQuestion);
            saveData();
            renderTeacherQuestions();
            updateTeacherDashboard();
            updateQuestionSubjectFilter();
            updateTeacherExamOptions();
            hideModal('teacherAddQuestionModal');
            document.getElementById('teacherAddQuestionForm').reset();
        }

        function handleTeacherCreateExam(event) {
            event.preventDefault();
            
            const title = document.getElementById('teacherExamTitle').value;
            const subject = document.getElementById('teacherExamSubject').value;
            const duration = parseInt(document.getElementById('teacherExamDuration').value);
            const questionCount = parseInt(document.getElementById('teacherExamQuestionCount').value);
            const selectedClass = document.getElementById('teacherExamClass').value;

            if (!title || !subject || !duration || !questionCount || !selectedClass) {
                alert('Mohon lengkapi semua field!');
                return;
            }

            const subjectQuestions = questions.filter(q => q.subject === subject);
            if (subjectQuestions.length < questionCount) {
                alert(`Soal ${subject} tidak cukup! Tersedia ${subjectQuestions.length} soal, dibutuhkan ${questionCount} soal.`);
                return;
            }

            const newExam = {
                id: Date.now(),
                title,
                subject,
                duration,
                questionCount,
                selectedClass,
                questions: shuffleArray([...subjectQuestions]).slice(0, questionCount),
                createdBy: currentUser.username,
                createdAt: new Date().toISOString(),
                isActive: true
            };

            activeExams.push(newExam);
            saveData();
            renderActiveExams();
            updateTeacherDashboard();
            document.getElementById('teacherExamForm').reset();
            
            alert(`Ujian "${title}" (${subject}) berhasil dibuat dan tersedia untuk kelas ${selectedClass}!`);
        }

        function renderTeacherStudents() {
            const tbody = document.getElementById('teacherStudentsTable');
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Belum ada data siswa. Import dari Excel atau tambah manual.</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(student => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4">${student.nis}</td>
                    <td class="py-3 px-4 font-medium">${student.name}</td>
                    <td class="py-3 px-4">${student.class}</td>
                    <td class="py-3 px-4">${student.email}</td>
                    <td class="py-3 px-4 font-mono text-sm">${student.password || '123'}</td>
                    <td class="py-3 px-4">
                        <button onclick="deleteStudent(${student.id})" class="text-red-500 hover:text-red-700 text-sm">üóëÔ∏è Hapus</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderTeacherQuestions() {
            const container = document.getElementById('teacherQuestionsList');
            const searchTerm = document.getElementById('teacherQuestionSearch').value.toLowerCase();
            const selectedSubject = document.getElementById('teacherQuestionSubjectFilter').value;
            
            let filteredQuestions = questions;
            
            if (searchTerm) {
                filteredQuestions = filteredQuestions.filter(question => 
                    question.question.toLowerCase().includes(searchTerm) ||
                    question.category.toLowerCase().includes(searchTerm) ||
                    question.subject.toLowerCase().includes(searchTerm)
                );
            }
            
            if (selectedSubject) {
                filteredQuestions = filteredQuestions.filter(question => 
                    question.subject === selectedSubject
                );
            }
            
            if (filteredQuestions.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">Tidak ada soal yang sesuai dengan filter.</div>';
                return;
            }

            container.innerHTML = filteredQuestions.map((question, index) => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex gap-2">
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${question.subject}</span>
                            <span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">${question.category}</span>
                        </div>
                        <button onclick="deleteQuestion(${question.id})" class="text-red-500 hover:text-red-700 text-sm">üóëÔ∏è Hapus</button>
                    </div>
                    <h4 class="font-medium text-gray-800 mb-3 question-text auto-direction">${index + 1}. ${formatTextWithImages(question.question, 'question')}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                        <div class="flex items-start space-x-2">
                            <span class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-xs font-medium mt-1 flex-shrink-0 ${question.correctAnswer === 'A' ? 'bg-green-100 text-green-800' : ''}">A</span>
                            <div class="option-text auto-direction flex-1">${formatTextWithImages(question.options.A, 'option')}</div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-xs font-medium mt-1 flex-shrink-0 ${question.correctAnswer === 'B' ? 'bg-green-100 text-green-800' : ''}">B</span>
                            <div class="option-text auto-direction flex-1">${formatTextWithImages(question.options.B, 'option')}</div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-xs font-medium mt-1 flex-shrink-0 ${question.correctAnswer === 'C' ? 'bg-green-100 text-green-800' : ''}">C</span>
                            <div class="option-text auto-direction flex-1">${formatTextWithImages(question.options.C, 'option')}</div>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-xs font-medium mt-1 flex-shrink-0 ${question.correctAnswer === 'D' ? 'bg-green-100 text-green-800' : ''}">D</span>
                            <div class="option-text auto-direction flex-1">${formatTextWithImages(question.options.D, 'option')}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderActiveExams() {
            const container = document.getElementById('activeExamsList');
            
            if (activeExams.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">Tidak ada ujian yang sedang berlangsung</div>';
                return;
            }

            container.innerHTML = activeExams.map(exam => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-medium text-gray-800">${exam.title}</h4>
                            <p class="text-sm text-gray-600">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs mr-2">${exam.subject}</span>
                                Kelas: ${exam.selectedClass} | Durasi: ${exam.duration} menit | Soal: ${exam.questionCount}
                            </p>
                            <p class="text-xs text-gray-500">Dibuat: ${new Date(exam.createdAt).toLocaleString('id-ID')}</p>
                        </div>
                        <div class="flex gap-2">
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Aktif</span>
                            <button onclick="deactivateExam(${exam.id})" class="text-red-500 hover:text-red-700 text-sm">üóëÔ∏è Nonaktifkan</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStudentDashboard() {
            renderAvailableExams();
            renderStudentResults();
        }

        function renderAvailableExams() {
            const container = document.getElementById('availableExamsList');
            const studentClass = currentUser.class;
            const availableExams = activeExams.filter(exam => exam.selectedClass === studentClass);
            
            if (availableExams.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">Tidak ada ujian yang tersedia saat ini</div>';
                return;
            }

            container.innerHTML = availableExams.map(exam => {
                const hasCompleted = examResults.some(result => 
                    result.student.id === currentUser.id && result.examId === exam.id
                );

                return `
                    <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${exam.title}</h3>
                                <p class="text-gray-600">
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-2">${exam.subject}</span>
                                    Durasi: ${exam.duration} menit | Jumlah soal: ${exam.questionCount}
                                </p>
                                <p class="text-sm text-gray-500">Kelas: ${exam.selectedClass}</p>
                            </div>
                            <div class="text-right">
                                ${hasCompleted ? 
                                    '<span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm">Sudah Dikerjakan</span>' :
                                    '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">Tersedia</span>'
                                }
                            </div>
                        </div>
                        <div class="flex justify-end">
                            ${hasCompleted ? 
                                '<button class="bg-gray-400 text-white px-6 py-2 rounded-lg cursor-not-allowed" disabled>Sudah Dikerjakan</button>' :
                                `<button onclick="startStudentExam(${exam.id})" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors font-medium">üöÄ Mulai Ujian</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function startStudentExam(examId) {
            const exam = activeExams.find(e => e.id === examId);
            
            if (!exam) {
                alert('Ujian tidak ditemukan!');
                return;
            }

            if (exam.questions.length === 0) {
                alert('Ujian ini tidak memiliki soal!');
                return;
            }

            currentExam = {
                ...exam,
                student: currentUser,
                answers: {},
                startTime: Date.now(),
                timeRemaining: exam.duration * 60
            };

            currentQuestionIndex = 0;
            startStudentExamInterface();
        }

        function startStudentExamInterface() {
            const examsList = document.getElementById('availableExamsList').parentElement;
            const examInterface = document.getElementById('studentExamInterface');
            
            examsList.classList.add('hidden');
            examInterface.classList.remove('hidden');
            
            document.getElementById('studentCurrentExamTitle').textContent = `${currentExam.title} - ${currentExam.subject}`;
            document.getElementById('studentCurrentInfo').textContent = `${currentUser.name} - ${currentUser.class}`;
            
            startStudentExamTimer();
            renderStudentCurrentQuestion();
            updateStudentProgress();
        }

        function startStudentExamTimer() {
            examTimer = setInterval(() => {
                currentExam.timeRemaining--;
                
                const minutes = Math.floor(currentExam.timeRemaining / 60);
                const seconds = currentExam.timeRemaining % 60;
                document.getElementById('studentExamTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (currentExam.timeRemaining <= 0) {
                    finishStudentExam();
                }
            }, 1000);
        }

        function renderStudentCurrentQuestion() {
            const question = currentExam.questions[currentQuestionIndex];
            const container = document.getElementById('studentQuestionContainer');
            
            // Shuffle options if not already done
            if (!question.shuffledOptions) {
                const optionTexts = [question.options.A, question.options.B, question.options.C, question.options.D];
                const shuffledTexts = [...optionTexts].sort(() => Math.random() - 0.5);
                
                question.shuffledOptions = {
                    A: shuffledTexts[0],
                    B: shuffledTexts[1], 
                    C: shuffledTexts[2],
                    D: shuffledTexts[3]
                };
                
                const originalCorrectText = question.options[question.correctAnswer];
                const newCorrectKey = Object.keys(question.shuffledOptions).find(key => 
                    question.shuffledOptions[key] === originalCorrectText
                );
                question.shuffledCorrectAnswer = newCorrectKey;
            }
            
            const options = ['A', 'B', 'C', 'D'];
            
            container.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">
                        Soal ${currentQuestionIndex + 1}
                    </h3>
                    <div class="text-gray-700 mb-6 question-text auto-direction">${formatTextWithImages(question.question, 'question')}</div>
                    <div class="space-y-4">
                        ${options.map(key => `
                            <div class="student-answer-option group relative overflow-hidden rounded-xl border-2 cursor-pointer transition-all duration-300 transform hover:scale-[1.02] hover:shadow-lg ${currentExam.answers[question.id] === key ? 'bg-gradient-to-r from-green-500 to-green-600 border-green-500 text-white shadow-lg' : 'bg-white border-gray-200 hover:border-green-300 hover:bg-green-50'}" 
                                 data-answer="${key}" onclick="selectStudentAnswer('${question.id}', '${key}')">
                                <div class="flex items-start p-5">
                                    <div class="flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center font-bold text-lg mr-4 mt-1 transition-all duration-300 ${currentExam.answers[question.id] === key ? 'bg-white bg-opacity-20 text-white border-2 border-white' : 'bg-green-100 text-green-600 group-hover:bg-green-200 border-2 border-green-200'}">
                                        ${key}
                                    </div>
                                    <div class="flex-1 text-lg leading-relaxed option-text auto-direction ${currentExam.answers[question.id] === key ? 'text-white font-medium' : 'text-gray-800 group-hover:text-green-800'}">${formatTextWithImages(question.shuffledOptions[key], 'option')}</div>
                                </div>
                                ${currentExam.answers[question.id] === key ? '<div class="absolute inset-0 bg-gradient-to-r from-green-400 to-green-500 opacity-10"></div>' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Update navigation buttons
            document.getElementById('studentPrevQuestion').disabled = currentQuestionIndex === 0;
            
            const nextBtn = document.getElementById('studentNextQuestion');
            const finishBtn = document.getElementById('studentFinishExam');
            
            if (currentQuestionIndex === currentExam.questions.length - 1) {
                nextBtn.classList.add('hidden');
                finishBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                finishBtn.classList.add('hidden');
            }
        }

        function selectStudentAnswer(questionId, answer) {
            currentExam.answers[questionId] = answer;
            
            // Update visual state
            const container = document.getElementById('studentQuestionContainer');
            container.querySelectorAll('.student-answer-option').forEach(option => {
                const answerKey = option.dataset.answer;
                const letterCircle = option.querySelector('.flex-shrink-0:first-child');
                const textSpan = option.querySelector('.flex-1');
                
                if (answerKey === answer) {
                    option.className = 'student-answer-option group relative overflow-hidden rounded-xl border-2 cursor-pointer transition-all duration-300 transform hover:scale-[1.02] hover:shadow-lg bg-gradient-to-r from-green-500 to-green-600 border-green-500 text-white shadow-lg';
                    letterCircle.className = 'flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center font-bold text-lg mr-4 transition-all duration-300 bg-white bg-opacity-20 text-white border-2 border-white';
                    textSpan.className = 'flex-1 text-lg leading-relaxed text-white font-medium';
                    
                    if (!option.querySelector('.absolute')) {
                        option.insertAdjacentHTML('beforeend', '<div class="absolute inset-0 bg-gradient-to-r from-green-400 to-green-500 opacity-10"></div>');
                    }
                } else {
                    option.className = 'student-answer-option group relative overflow-hidden rounded-xl border-2 cursor-pointer transition-all duration-300 transform hover:scale-[1.02] hover:shadow-lg bg-white border-gray-200 hover:border-green-300 hover:bg-green-50';
                    letterCircle.className = 'flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center font-bold text-lg mr-4 transition-all duration-300 bg-green-100 text-green-600 group-hover:bg-green-200 border-2 border-green-200';
                    textSpan.className = 'flex-1 text-lg leading-relaxed text-gray-800 group-hover:text-green-800';
                    
                    const overlay = option.querySelector('.absolute');
                    if (overlay) overlay.remove();
                }
            });
        }

        function navigateStudentQuestion(direction) {
            const newIndex = currentQuestionIndex + direction;
            if (newIndex >= 0 && newIndex < currentExam.questions.length) {
                currentQuestionIndex = newIndex;
                renderStudentCurrentQuestion();
                updateStudentProgress();
            }
        }

        function updateStudentProgress() {
            const progress = ((currentQuestionIndex + 1) / currentExam.questions.length) * 100;
            document.getElementById('studentProgressBar').style.width = `${progress}%`;
            document.getElementById('studentQuestionProgress').textContent = 
                `${currentQuestionIndex + 1}/${currentExam.questions.length}`;
        }

        function finishStudentExam() {
            if (examTimer) {
                clearInterval(examTimer);
            }

            // Calculate score
            let correctAnswers = 0;
            
            currentExam.questions.forEach((question, index) => {
                const studentAnswer = currentExam.answers[question.id];
                
                let correctAnswer = question.shuffledCorrectAnswer;
                
                if (!correctAnswer && question.shuffledOptions) {
                    const originalCorrectText = question.options[question.correctAnswer];
                    correctAnswer = Object.keys(question.shuffledOptions).find(key => 
                        question.shuffledOptions[key] === originalCorrectText
                    );
                    question.shuffledCorrectAnswer = correctAnswer;
                }
                
                if (!correctAnswer) {
                    correctAnswer = question.correctAnswer;
                }
                
                const normalizedStudentAnswer = studentAnswer ? studentAnswer.toUpperCase() : '';
                const normalizedCorrectAnswer = correctAnswer ? correctAnswer.toUpperCase() : '';
                
                if (normalizedStudentAnswer === normalizedCorrectAnswer) {
                    correctAnswers++;
                }
            });

            const score = currentExam.questions.length > 0 ? Math.round((correctAnswers / currentExam.questions.length) * 100) : 0;
            
            const result = {
                id: Date.now(),
                examId: currentExam.id,
                examTitle: currentExam.title,
                examSubject: currentExam.subject,
                student: currentExam.student,
                score: score,
                correctAnswers: correctAnswers,
                totalQuestions: currentExam.questions.length,
                duration: Math.round((Date.now() - currentExam.startTime) / 1000 / 60),
                date: new Date().toLocaleDateString('id-ID')
            };

            examResults.push(result);
            saveData();
            
            alert(`Ujian selesai!\nMata Pelajaran: ${currentExam.subject}\nNilai: ${score}\nJawaban benar: ${correctAnswers}/${currentExam.questions.length}`);
            
            // Reset exam interface
            document.getElementById('studentExamInterface').classList.add('hidden');
            document.getElementById('availableExamsList').parentElement.classList.remove('hidden');
            currentExam = null;
            
            updateStudentDashboard();
        }

        function renderStudentResults() {
            const container = document.getElementById('studentResultsList');
            const studentResults = examResults.filter(result => result.student.id === currentUser.id);
            
            if (studentResults.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">Belum ada riwayat ujian.</div>';
                return;
            }

            container.innerHTML = studentResults.map(result => `
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${result.examTitle}</h3>
                            <p class="text-gray-600">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-2">${result.examSubject || 'Umum'}</span>
                                Tanggal: ${result.date}
                            </p>
                        </div>
                        <div class="mt-2 md:mt-0">
                            <span class="inline-block px-4 py-2 rounded-full text-white font-bold ${result.score >= 75 ? 'bg-green-500' : result.score >= 60 ? 'bg-yellow-500' : 'bg-red-500'}">
                                ${result.score}
                            </span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm text-gray-600">
                        <div>
                            <span class="block font-medium">Jawaban Benar</span>
                            <span>${result.correctAnswers}/${result.totalQuestions}</span>
                        </div>
                        <div>
                            <span class="block font-medium">Durasi</span>
                            <span>${result.duration} menit</span>
                        </div>
                        <div>
                            <span class="block font-medium">Status</span>
                            <span class="${result.score >= 75 ? 'text-green-600' : result.score >= 60 ? 'text-yellow-600' : 'text-red-600'} font-medium">
                                ${result.score >= 75 ? 'Lulus' : result.score >= 60 ? 'Cukup' : 'Tidak Lulus'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTeacherResults() {
            const container = document.getElementById('teacherResultsList');
            
            if (examResults.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">Belum ada hasil ujian.</div>';
                return;
            }

            container.innerHTML = examResults.map(result => `
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${result.examTitle}</h3>
                            <p class="text-gray-600">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-2">${result.examSubject || 'Umum'}</span>
                                ${result.student.name} - ${result.student.class}
                            </p>
                        </div>
                        <div class="mt-2 md:mt-0">
                            <span class="inline-block px-4 py-2 rounded-full text-white font-bold ${result.score >= 75 ? 'bg-green-500' : result.score >= 60 ? 'bg-yellow-500' : 'bg-red-500'}">
                                ${result.score}
                            </span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600">
                        <div>
                            <span class="block font-medium">Benar</span>
                            <span>${result.correctAnswers}/${result.totalQuestions}</span>
                        </div>
                        <div>
                            <span class="block font-medium">Durasi</span>
                            <span>${result.duration} menit</span>
                        </div>
                        <div>
                            <span class="block font-medium">Tanggal</span>
                            <span>${result.date}</span>
                        </div>
                        <div>
                            <button onclick="deleteResult(${result.id})" class="text-red-500 hover:text-red-700">üóëÔ∏è Hapus</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Utility functions
        function deleteStudent(id) {
            if (confirm('Yakin ingin menghapus siswa ini?')) {
                students = students.filter(s => s.id !== id);
                saveData();
                renderTeacherStudents();
                updateTeacherDashboard();
            }
        }

        function deleteQuestion(id) {
            if (confirm('Yakin ingin menghapus soal ini?')) {
                questions = questions.filter(q => q.id !== id);
                saveData();
                renderTeacherQuestions();
                updateTeacherDashboard();
                updateQuestionSubjectFilter();
                updateTeacherExamOptions();
            }
        }

        function deleteResult(id) {
            if (confirm('Yakin ingin menghapus hasil ujian ini?')) {
                examResults = examResults.filter(r => r.id !== id);
                saveData();
                renderTeacherResults();
                updateTeacherDashboard();
            }
        }

        function deactivateExam(id) {
            if (confirm('Yakin ingin menonaktifkan ujian ini?')) {
                activeExams = activeExams.filter(e => e.id !== id);
                saveData();
                renderActiveExams();
                updateTeacherDashboard();
                updateStudentDashboard();
            }
        }

        function filterTeacherStudents() {
            const search = document.getElementById('teacherStudentSearch').value.toLowerCase();
            const filteredStudents = students.filter(student => 
                student.name.toLowerCase().includes(search) ||
                student.nis.toLowerCase().includes(search) ||
                student.class.toLowerCase().includes(search)
            );
            
            const tbody = document.getElementById('teacherStudentsTable');
            tbody.innerHTML = filteredStudents.map(student => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4">${student.nis}</td>
                    <td class="py-3 px-4 font-medium">${student.name}</td>
                    <td class="py-3 px-4">${student.class}</td>
                    <td class="py-3 px-4">${student.email}</td>
                    <td class="py-3 px-4 font-mono text-sm">${student.password || '123'}</td>
                    <td class="py-3 px-4">
                        <button onclick="deleteStudent(${student.id})" class="text-red-500 hover:text-red-700 text-sm">üóëÔ∏è Hapus</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterTeacherQuestions() {
            renderTeacherQuestions();
        }

        function updateQuestionSubjectFilter() {
            const select = document.getElementById('teacherQuestionSubjectFilter');
            const subjects = [...new Set(questions.map(q => q.subject))].filter(s => s);
            select.innerHTML = '<option value="">Semua Mata Pelajaran</option>' +
                subjects.map(subject => `<option value="${subject}">${subject}</option>`).join('');
        }

        function updateTeacherExamOptions() {
            // Update class options
            const classSelect = document.getElementById('teacherExamClass');
            const classes = [...new Set(students.map(student => student.class))].filter(cls => cls);
            classSelect.innerHTML = '<option value="">Pilih kelas untuk ujian</option>' +
                classes.map(cls => `<option value="${cls}">${cls}</option>`).join('');

            // Update subject options
            const subjectSelect = document.getElementById('teacherExamSubject');
            const subjects = [...new Set(questions.map(q => q.subject))].filter(s => s);
            subjectSelect.innerHTML = '<option value="">Pilih mata pelajaran</option>' +
                subjects.map(subject => `<option value="${subject}">${subject}</option>`).join('');
        }

        function updateAvailableQuestionsCount() {
            const selectedSubject = document.getElementById('teacherExamSubject').value;
            const availableCount = selectedSubject ? questions.filter(q => q.subject === selectedSubject).length : 0;
            document.getElementById('availableQuestionsCount').textContent = `Soal tersedia: ${availableCount}`;
        }

        function updateTeacherDashboard() {
            document.getElementById('teacherTotalStudents').textContent = students.length;
            document.getElementById('teacherTotalQuestions').textContent = questions.length;
            document.getElementById('teacherActiveExams').textContent = activeExams.length;
            
            const avgScore = examResults.length > 0 
                ? Math.round(examResults.reduce((sum, result) => sum + result.score, 0) / examResults.length)
                : 0;
            document.getElementById('teacherAverageScore').textContent = avgScore;
            
            renderTeacherResults();
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        async function saveData() {
            // Save to local storage first
            localStorage.setItem('examSystem', JSON.stringify({
                students,
                questions,
                examResults,
                activeExams
            }));

            // Then sync to Google Sheets if online
            if (isOnlineMode) {
                await saveDataToGoogleSheets();
            }
        }

        async function loadStoredData() {
            // Load from local storage first
            const stored = localStorage.getItem('examSystem');
            if (stored) {
                const data = JSON.parse(stored);
                students = data.students || [];
                questions = data.questions || [];
                examResults = data.examResults || [];
                activeExams = data.activeExams || [];
            }

            // Then try to load from Google Sheets if online
            if (isOnlineMode) {
                await loadDataFromGoogleSheets();
            }
        }

        async function syncData() {
            const syncButton = document.getElementById('syncButton');
            const originalText = syncButton.innerHTML;
            
            syncButton.innerHTML = '<span>‚è≥</span><span>Syncing...</span>';
            syncButton.disabled = true;

            try {
                console.log('Manual sync started...');
                
                // First check connection
                await checkOnlineMode();
                
                if (isOnlineMode) {
                    console.log('Connection OK, syncing data...');
                    
                    // Save current data to Google Sheets
                    const saveResult = await saveDataToGoogleSheets();
                    console.log('Save result:', saveResult);
                    
                    // Load fresh data from Google Sheets
                    await loadDataFromGoogleSheets();
                    
                    alert('‚úÖ Data berhasil disinkronkan dengan Google Sheets!\n\n' +
                          `üìä Siswa: ${students.length}\n` +
                          `‚ùì Soal: ${questions.length}\n` +
                          `üìù Ujian Aktif: ${activeExams.length}\n` +
                          `üìà Hasil: ${examResults.length}`);
                } else {
                    if (APPS_SCRIPT_URL.includes('YOUR_SCRIPT_ID')) {
                        alert('‚ö†Ô∏è URL Apps Script belum dikonfigurasi!\n\n' +
                              'Langkah-langkah:\n' +
                              '1. Buat Google Apps Script\n' +
                              '2. Deploy sebagai web app\n' +
                              '3. Ganti YOUR_SCRIPT_ID dengan ID deployment Anda\n' +
                              '4. Pastikan akses diatur ke "Anyone"');
                    } else {
                        alert('‚ùå Tidak dapat terhubung ke Google Sheets.\n\n' +
                              'Periksa:\n' +
                              '‚Ä¢ Koneksi internet\n' +
                              '‚Ä¢ URL Apps Script sudah benar\n' +
                              '‚Ä¢ Apps Script sudah di-deploy\n' +
                              '‚Ä¢ Akses diatur ke "Anyone"\n\n' +
                              'Data tetap tersimpan di local storage.');
                    }
                }
            } catch (error) {
                console.error('Sync error:', error);
                alert('‚ùå Gagal sinkronisasi: ' + error.message + '\n\nData tetap tersimpan di local storage.');
            } finally {
                syncButton.innerHTML = originalText;
                syncButton.disabled = false;
            }
        }

        function updateAllDashboards() {
            if (currentUser) {
                if (currentUser.role === 'teacher') {
                    renderTeacherStudents();
                    renderTeacherQuestions();
                    updateTeacherDashboard();
                    updateTeacherExamOptions();
                    updateQuestionSubjectFilter();
                    renderActiveExams();
                } else if (currentUser.role === 'student') {
                    updateStudentDashboard();
                }
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98321644a788fd94',t:'MTc1ODU0NzA5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
